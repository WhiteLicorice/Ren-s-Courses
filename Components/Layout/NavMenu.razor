@inject NavigationManager Nm

@* 'fixed' to lock it to the viewport strictly *@
<header id="main-navbar"
    class="fixed top-0 left-0 right-0 z-40 w-full border-b border-border-muted bg-bg-base transition-transform duration-300">
    <div class="mx-auto flex h-16 max-w-5xl items-center justify-between px-4 sm:px-6 xl:px-0">

        @* Logo *@
        <div class="flex lg:w-0 lg:flex-1">
            <a href="" class="-m-1.5 p-1.5">
                <div class="text-xl font-bold text-text-main hover:text-accent transition-colors">
                    @WebsiteKeys.Title
                </div>
            </a>
        </div>

        @* DESKTOP NAV: Items + Dropdown + Theme Toggle *@
        <nav class="hidden space-x-6 sm:flex items-center">

            @* 1. Render the first 3 items normally *@
            @foreach (var item in menuItems.Take(3))
            {
                <NavLink ActiveClass="text-accent bg-accent-dim border border-accent/20 rounded"
                    class="inline-flex items-center px-3 py-1 text-sm font-medium text-text-dim hover:text-accent transition-all"
                    Match="@(item.Link == "" ? NavLinkMatch.All : NavLinkMatch.Prefix)" href="@item.Link"
                    target="@item.Target">
                    @((MarkupString)item.Name)
                    @if (item.Icon != null)
                    {
                        <span class="ml-2"><Svg Icon="item.Icon" SizeClasses="w-4 h-4" /></span>
                    }
                </NavLink>
            }

            @* 2. Render Hamburger Dropdown for the rest *@
            @if (menuItems.Count > 3)
            {
                <div class="relative">
                    <button id="desktop-dropdown-btn" type="button"
                        class="inline-flex items-center justify-center p-2 rounded-md text-text-dim hover:text-accent hover:bg-transparent focus:outline-none focus:ring-0 focus:bg-transparent transition-colors">
                        <span class="sr-only">More menu</span>
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                        </svg>
                    </button>

                    @* Dropdown Menu *@
                    <div id="desktop-dropdown-menu"
                        class="hidden absolute right-0 mt-2 w-56 origin-top-right rounded-lg bg-surface border border-border-muted shadow-xl ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
                        <div class="py-1 max-h-48 overflow-y-auto">
                            @foreach (var item in menuItems.Skip(3))
                            {
                                <NavLink ActiveClass="text-accent bg-accent-dim"
                                    class="block px-4 py-2 text-sm text-text-dim hover:bg-surface-hover hover:text-accent transition-colors"
                                    Match="@(item.Link == "" ? NavLinkMatch.All : NavLinkMatch.Prefix)" href="@item.Link"
                                    target="@item.Target">
                                    <div class="flex items-center justify-between">
                                        <span>@((MarkupString)item.Name)</span>
                                        @if (item.Icon != null)
                                        {
                                            <Svg Icon="item.Icon" SizeClasses="w-3 h-3 opacity-70" />
                                        }
                                    </div>
                                </NavLink>
                            }
                        </div>
                    </div>
                </div>
            }

            @* 3. THEME TOGGLE (DESKTOP) *@
            @* We use a common class 'theme-toggle-btn' for JS targeting *@
            <button type="button"
                class="theme-toggle-btn p-2 text-text-dim hover:text-accent transition-colors rounded-md"
                aria-label="Toggle Theme">
                <svg class="icon-sun hidden h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                </svg>
                <svg class="icon-moon hidden h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                </svg>
            </button>

        </nav>

        @* Mobile Toggle Button *@
        <div class="flex flex-1 justify-end sm:hidden">
            <button id="toggle-button" type="button" class="-m-2.5 p-2.5 text-text-dim hover:text-accent">
                <span class="sr-only">Open main menu</span>
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
            </button>
        </div>
    </div>
</header>

@* Spacer Div *@
<div class="h-16 w-full"></div>

@* MOBILE MENU CONTAINER *@
<div id="mobile-menu-container" class="hidden fixed inset-0 z-50">

    <div id="mobile-backdrop" class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity opacity-100">
    </div>

    <div
        class="relative w-full h-full max-h-screen overflow-y-auto bg-bg-base border-b border-border-muted shadow-2xl transform transition-transform">

        <div
            class="flex items-center justify-between px-6 py-4 border-b border-border-muted/50 sticky top-0 bg-bg-base z-10">
            <span class="font-bold text-text-main">Navigate</span>

            <div class="flex items-center gap-2">
                @* THEME TOGGLE (MOBILE) *@
                <button type="button"
                    class="theme-toggle-btn p-2 text-text-dim hover:text-accent bg-surface rounded-md border border-border-muted">
                    <svg class="icon-sun hidden h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                    </svg>
                    <svg class="icon-moon hidden h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                    </svg>
                </button>

                <button id="close-mobile-menu-button"
                    class="p-2 text-text-dim hover:text-accent bg-surface rounded-md border border-border-muted">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>

        <div class="px-6 py-6 space-y-2 pb-24">
            @foreach (var item in menuItems)
            {
                <NavLink
                    class="block rounded-lg px-3 py-3 text-base font-semibold leading-7 text-text-main hover:bg-accent-dim hover:text-accent transition-colors"
                    href="@item.Link" Match="@(item.Link == "" ? NavLinkMatch.All : NavLinkMatch.Prefix)"
                    target="@item.Target">
                    <div class="flex items-center gap-3">
                        @((MarkupString)item.Name)
                        <Svg Icon="item.Icon" />
                    </div>
                </NavLink>
            }
        </div>
    </div>
</div>

<script>
    // --- Mobile Menu Logic ---
    const menuContainer = document.querySelector('#mobile-menu-container');
    const backdrop = document.querySelector('#mobile-backdrop');
    const toggleBtn = document.querySelector('#toggle-button');
    const closeBtn = document.querySelector('#close-mobile-menu-button');

    const toggleMobileMenu = () => {
        const isHidden = menuContainer.classList.contains('hidden');
        if (isHidden) {
            menuContainer.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        } else {
            menuContainer.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }
    };

    // Trigger open
    toggleBtn.addEventListener('click', toggleMobileMenu);

    // Trigger close (X button)
    closeBtn.addEventListener('click', toggleMobileMenu);

    // Trigger close (Clicking the Backdrop/Gap)
    backdrop.addEventListener('click', toggleMobileMenu);

    // --- Desktop Dropdown Logic ---
    const desktopBtn = document.getElementById('desktop-dropdown-btn');
    const desktopMenu = document.getElementById('desktop-dropdown-menu');

    if (desktopBtn && desktopMenu) {
        // Toggle on click
        desktopBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            desktopMenu.classList.toggle('hidden');
        });

        // Close when clicking outside
        document.addEventListener('click', (e) => {
            if (!desktopMenu.classList.contains('hidden') && !desktopMenu.contains(e.target) && e.target !== desktopBtn) {
                desktopMenu.classList.add('hidden');
            }
        });
    }

    // --- THEME TOGGLE LOGIC ---
    function initThemeToggle() {
        const btns = document.querySelectorAll('.theme-toggle-btn');

        // Helper to update icons based on current theme
        const updateIcons = (theme) => {
            btns.forEach(btn => {
                const sun = btn.querySelector('.icon-sun');
                const moon = btn.querySelector('.icon-moon');

                if (theme === 'light') {
                    // In Light mode, show Moon (to switch to Dark)
                    sun.classList.add('hidden');
                    moon.classList.remove('hidden');
                } else {
                    // In Dark mode, show Sun (to switch to Light)
                    moon.classList.add('hidden');
                    sun.classList.remove('hidden');
                }
            });
        };

        // 1. Initial Icon State
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
        updateIcons(currentTheme);

        // 2. Click Handler
        btns.forEach(btn => {
            btn.addEventListener('click', () => {
                const current = document.documentElement.getAttribute('data-theme');
                const next = current === 'light' ? 'dark' : 'light';

                // Call your existing site.js function
                if (window.switchPrismTheme) {
                    window.switchPrismTheme(next);
                    updateIcons(next);
                }
            });
        });

        // 3. Listen for changes (e.g. if System toggles)
        // This ensures the button icon updates if the system preference changes
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === "attributes" && mutation.attributeName === "data-theme") {
                    updateIcons(document.documentElement.getAttribute('data-theme'));
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true });
    }

    // Initialize immediately
    initThemeToggle();


    // --- Navbar Scroll Logic ---
    let lastScrollTop = 0;
    const navbar = document.getElementById('main-navbar');

    window.addEventListener('scroll', function () {
        let scrollTop = window.pageYOffset || document.documentElement.scrollTop;

        // Always show navbar at the very top
        if (scrollTop <= 64) {
            navbar.classList.remove('-translate-y-full');
            lastScrollTop = scrollTop;
            return;
        }

        if (scrollTop > lastScrollTop) {
            // DOWN SCROLL -> Hide Navbar
            navbar.classList.add('-translate-y-full');

            // Force close desktop dropdown if open
            if (desktopMenu && !desktopMenu.classList.contains('hidden')) {
                desktopMenu.classList.add('hidden');
            }

            // Logic for mobile menu
            if (menuContainer.classList.contains('hidden')) {
                // only hide navbar if mobile menu is CLOSED
                navbar.classList.add('-translate-y-full');
            } else {
                // if mobile menu OPEN, keep navbar visible
                navbar.classList.remove('-translate-y-full');
            }

        } else {
            // UP SCROLL -> Show Navbar
            navbar.classList.remove('-translate-y-full');
        }
        lastScrollTop = scrollTop;
    });
</script>

@code {
    List<MenuItem> menuItems =
    [
    new("Home", "", null, "_self"),
new("Materials", "materials", null, "_self"),
new MenuItem("Showcase", "projects", null, "_self"),
new(Name: "Submissions", "https://forms.gle/mRFBXwhuR3LdvSN3A", null, "_blank"),
new(Name: "Bookings", "bookings", null, "_self"),
new(Name: "Calendar", "calendar", null, "_self"),
new("Grades",
"https://script.google.com/a/macros/up.edu.ph/s/AKfycbzDek55-JQ1pRgdjQsj8Xoe3CMA-LCwt4ARG3f7SCoskOwsVfIhY0ztXSLVLOfH0i_smw/exec",
null, "_blank"),
];

    record MenuItem(string Name, string Link, Svg.Icons? Icon, string Target);
}