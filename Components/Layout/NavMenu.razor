@inject NavigationManager Nm

@* 'fixed' to lock it to the viewport strictly *@
<header id="main-navbar"
    class="fixed top-0 left-0 right-0 z-40 w-full border-b border-borderDark bg-bgDark transition-transform duration-300">
    <div class="mx-auto flex h-16 max-w-5xl items-center justify-between px-4 sm:px-6 xl:px-0">

        <div class="flex lg:w-0 lg:flex-1">
            <a href="" class="-m-1.5 p-1.5">
                <div class="text-xl font-bold text-gray-100 hover:text-red-500 transition-colors">@WebsiteKeys.Title
                </div>
            </a>
        </div>

        <nav class="hidden space-x-6 sm:flex">
            @foreach (var item in menuItems)
            {
                <NavLink ActiveClass="text-red-400 bg-red-500/10 border border-red-500/20 rounded"
                    class="inline-flex items-center px-3 py-1 text-sm font-medium text-gray-300 hover:text-red-400 transition-all"
                    Match="@(item.Link == "" ? NavLinkMatch.All : NavLinkMatch.Prefix)" href="@item.Link"
                    target="@item.Target">
                    @((MarkupString)item.Name)
                    @if (item.Icon != null)
                    {
                        <span class="ml-2"><Svg Icon="item.Icon" SizeClasses="w-4 h-4" /></span>
                    }
                </NavLink>
            }
        </nav>

        <div class="flex flex-1 justify-end sm:hidden">
            <button id="toggle-button" type="button" class="-m-2.5 p-2.5 text-gray-400 hover:text-red-500">
                <span class="sr-only">Open main menu</span>
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
            </button>
        </div>
    </div>
</header>

@* Spacer Div: Keeps content from hiding behind the fixed header *@
<div class="h-16 w-full"></div>

<div id="mobile-menu-container" class="hidden fixed inset-0 z-50">

    <div id="mobile-backdrop" class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity opacity-100">
    </div>

    <div class="relative w-full bg-bgDark border-b border-borderDark shadow-2xl transform transition-transform">

        <div class="flex items-center justify-between px-6 py-4 border-b border-borderDark/50">
            <span class="font-bold text-gray-100">Menu</span>
            <button id="close-mobile-menu-button" class="p-2 text-gray-400 hover:text-red-500 bg-cardDark rounded-md">
                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <div class="px-6 py-6 space-y-2">
            @foreach (var item in menuItems)
            {
                <NavLink
                    class="block rounded-lg px-3 py-3 text-base font-semibold leading-7 text-gray-100 hover:bg-red-500/10 hover:text-red-400 transition-colors"
                    href="@item.Link" Match="@(item.Link == "" ? NavLinkMatch.All : NavLinkMatch.Prefix)"
                    target="@item.Target">
                    <div class="flex items-center gap-3">
                        @((MarkupString)item.Name)
                        <Svg Icon="item.Icon" />
                    </div>
                </NavLink>
            }
        </div>
    </div>
</div>

<script>
    const menuContainer = document.querySelector('#mobile-menu-container');
    const backdrop = document.querySelector('#mobile-backdrop');
    const toggleBtn = document.querySelector('#toggle-button');
    const closeBtn = document.querySelector('#close-mobile-menu-button');

    const toggleMobileMenu = () => {
        const isHidden = menuContainer.classList.contains('hidden');

        if (isHidden) {
            // Open
            menuContainer.classList.remove('hidden');
            document.body.classList.add('overflow-hidden'); // Lock body scroll
        } else {
            // Close
            menuContainer.classList.add('hidden');
            document.body.classList.remove('overflow-hidden'); // Unlock body scroll
        }
    };

    // Trigger open
    toggleBtn.addEventListener('click', toggleMobileMenu);

    // Trigger close (X button)
    closeBtn.addEventListener('click', toggleMobileMenu);

    // Trigger close (Clicking the Backdrop/Gap)
    backdrop.addEventListener('click', toggleMobileMenu);

    // Scroll Direction Logic (Hide/Show Navbar)
    let lastScrollTop = 0;
    const navbar = document.getElementById('main-navbar');

    window.addEventListener('scroll', function () {
        let scrollTop = window.pageYOffset || document.documentElement.scrollTop;

        // Only hide navbar if we scroll down AND the mobile menu is NOT open
        // Add a buffer (e.g. 64px) so it doesn't twitch at the very top
        if (scrollTop <= 64) {
            navbar.classList.remove('-translate-y-full');
            lastScrollTop = scrollTop;
            return;
        }

        if (scrollTop > lastScrollTop && menuContainer.classList.contains('hidden')) {
            // Downscroll -> Hide
            navbar.classList.add('-translate-y-full');
        } else {
            // Upscroll -> Show
            navbar.classList.remove('-translate-y-full');
        }
        lastScrollTop = scrollTop;
    });
</script>

@code {
    List<MenuItem> menuItems =
    [
        new("Home", "", null, "_self"),
        new("Materials", "tags", null, "_self"),
        new MenuItem("Showcase", "projects", null, "_self"),
        new("Submissions", "https://forms.gle/mRFBXwhuR3LdvSN3A", null, "_blank"),
        new("Grades",
        "https://script.google.com/a/macros/up.edu.ph/s/AKfycbzDek55-JQ1pRgdjQsj8Xoe3CMA-LCwt4ARG3f7SCoskOwsVfIhY0ztXSLVLOfH0i_smw/exec",
        null, "_blank"),
        new("", WebsiteKeys.GitHubRepo, Svg.Icons.Github, "_blank")
    ];

    record MenuItem(string Name, string Link, Svg.Icons? Icon, string Target);
}