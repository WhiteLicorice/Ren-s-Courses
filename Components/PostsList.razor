@using System.Globalization
@using BlazorStatic
@using BlazorStatic.Services
@using BlazorStaticMinimalBlog.Models
@inject BlazorStaticContentService<CourseFrontMatter> blazorStaticContentService
@inject BlazorStaticService blazorStaticService

<div class="grid gap-6 sm:grid-cols-2 lg:gap-8 mt-8">
    @foreach (var post in posts)
    {
        <article class="group relative flex flex-col justify-between rounded-lg border border-borderDark bg-cardDark p-6 shadow-md transition-all hover:border-red-500/50 hover:shadow-[0_0_15px_rgba(239,68,68,0.15)] hover:-translate-y-1">

            @* --- TOP META: Date & Tags --- *@
            <div class="flex items-center justify-between text-xs">
                <time datetime="@post.FrontMatter.Published.ToString("yyyy-MM-dd")" class="text-gray-500">
                    @post.FrontMatter.Published.ToString("MMM d, yyyy", new CultureInfo("en-US"))
                </time>
                
                @if (post.FrontMatter.Tags.Any())
                {
                    <span class="font-mono text-red-400 bg-red-500/10 px-2 py-1 rounded border border-red-500/20">
                        @post.FrontMatter.Tags.First()
                    </span>
                }
            </div>

            <div class="mt-4 mb-4 flex-grow">
                
                @* --- TITLE --- *@
                <h3 class="text-lg font-bold text-gray-100 group-hover:text-red-400 transition-colors">
                    <a href="@blazorStaticContentService.Options.PageUrl/@(post.Url)">
                        <span class="absolute inset-0"></span>
                        @post.FrontMatter.Title
                    </a>
                </h3>

                @* --- NEW: SUBTITLE --- *@
                @if (!string.IsNullOrWhiteSpace(post.FrontMatter.Subtitle))
                {
                    <div class="text-xs font-mono text-gray-500 mt-1 mb-2">
                        // @post.FrontMatter.Subtitle
                    </div>
                }

                @* --- NEW: DEADLINE BADGE --- *@
                @if (post.FrontMatter.Deadline.HasValue)
                {
                    <div class="mt-2 mb-2 inline-flex items-center gap-1.5 rounded border border-yellow-600/30 bg-yellow-600/10 px-2 py-1 text-xs font-medium text-yellow-500">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3 h-3">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z" clip-rule="evenodd" />
                        </svg>
                        <span>Due: @post.FrontMatter.Deadline.Value.ToString("MMM dd HH:mm")</span>
                    </div>
                }

                @* --- LEAD --- *@
                <div class="mt-2 line-clamp-2 text-sm text-gray-400">
                    @((MarkupString)post.FrontMatter.Lead)
                </div>
            </div>

            @* --- FOOTER: Fake Terminal Command --- *@
            <div class="mt-auto flex items-center border-t border-borderDark pt-4">
                <span class="font-mono text-sm text-gray-500 group-hover:text-gray-300 transition-colors">
                    <span class="text-red-500">$</span> ./read.sh 
                    <span class="text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">_</span>
                </span>
            </div>
        </article>
    }
</div>

@code {
    private List<Post<CourseFrontMatter>> posts = new();
    
    [Parameter] 
    public List<Post<CourseFrontMatter>>? Posts { get; set; }
    
    private HashSet<String> HiddenTags = new HashSet<String> { };

    protected override void OnInitialized()
    {
        DateTime now = DateTime.UtcNow;
        
        // Use provided posts list OR fetch from service if null
        var sourcePosts = Posts ?? blazorStaticContentService.Posts;

        posts = sourcePosts
            .Where(p => 
                // 1. Must not be a draft
                !p.FrontMatter.IsDraft 
                // 2. Must be published in the past
                && p.FrontMatter.Published.ToUniversalTime() <= now 
                // 3. Must be from THIS year (Your specific constraint)
                && p.FrontMatter.Published.ToUniversalTime().Year == now.Year 
                // 4. Must not have hidden tags
                && !HasHiddenTag(p.FrontMatter.Tags)
            )
            .OrderByDescending(p => p.FrontMatter.Published)
            .ToList();
            
        base.OnInitialized();
    }

    private bool HasHiddenTag(List<String> tags)
    {
        // Optimized: HashSet.Overlaps is faster than manual foreach for checking intersections
        return HiddenTags.Overlaps(tags);
    }
}