@page "/calendar"
@using System.Globalization
@using BlazorStatic
@using BlazorStatic.Services
@using BlazorStaticMinimalBlog.Models
@using BlazorStaticMinimalBlog.Services
@inject CourseContentProvider ContentProvider
@inject HolidaysProvider HolidaysProvider
@inject BlazorStaticContentService<CourseFrontMatter> blazorStaticContentService
@inject BlazorStaticContentService<CalendarEventFrontmatter> calendarEventService
@inject IJSRuntime JSRuntime

<div class="mx-auto max-w-[1400px] py-10 sm:py-16 animate-fade-in select-none px-4">

    @* --- HEADER SECTION --- *@
    <div class="text-center mb-8">
        @* Dynamic Header controlled by JS *@
        <h1 id="cal-title" class="text-3xl font-bold tracking-tight text-text-main sm:text-5xl mb-4 font-mono">
            <span class="text-accent">./</span>Calendar
        </h1>

        <p id="cal-subtitle" class="text-text-dim max-w-2xl mx-auto"
               data-default="Displaying schedule for semester: @BuildTimeProvider.TermStart.ToString("MMM d, yyyy") to @BuildTimeProvider.TermEnd.ToString("MMM d, yyyy").">
            Displaying schedule for semester: @BuildTimeProvider.TermStart.ToString("MMM d, yyyy") to
            @BuildTimeProvider.TermEnd.ToString("MMM d, yyyy").
        </p>

        <div class="mt-8 mb-8 w-full h-px bg-gradient-to-r from-transparent via-accent/50 to-transparent"></div>

        @* Reset Button (Hidden by default via CSS/JS) *@
        <div id="cal-reset-btn" class="flex justify-center mb-6" style="display: none;">
            <button onclick="filterCalendar(null)"
                    class="inline-flex items-center gap-2 text-sm text-text-dim hover:text-accent transition-colors group bg-transparent border-none cursor-pointer">
                <svg class="w-4 h-4 transition-transform group-hover:-translate-x-1" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                View Full Schedule
            </button>
        </div>
    </div>

    @* --- CONTROLS: TAG FILTERS --- *@
    <div class="flex flex-wrap justify-center gap-3 mb-8 max-w-5xl mx-auto">
        @foreach (var tag in ContentProvider.GetAllTags())
        {
            @* JS Filter Button *@
            <button onclick="filterCalendar('@tag')" data-tag="@tag"
                    class="filter-btn text-xs px-4 py-2 rounded-md border transition-all font-mono font-bold cursor-pointer bg-surface border-border-muted text-text-dim hover:border-accent/50 hover:text-accent hover:shadow-lg hover:shadow-accent/10">
                #@tag
            </button>
        }
    </div>

    @* --- CALENDAR NAVIGATOR --- *@
    <div
        class="flex items-center justify-between bg-surface border border-border-muted rounded-t-lg p-4 border-b-0 max-w-full mx-auto shadow-lg relative z-20">
        <button onclick="changeMonth(-1)"
                class="group p-2 rounded-md hover:bg-accent-dim transition-all border border-transparent hover:border-accent/30">
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="h-6 w-6 text-text-dim group-hover:text-accent transition-colors" viewBox="0 0 20 20"
                 fill="currentColor">
                <path fill-rule="evenodd"
                      d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                      clip-rule="evenodd" />
            </svg>
        </button>

        <div id="month-label"
             class="text-center font-bold text-text-main font-mono text-xl md:text-2xl tracking-tight uppercase drop-shadow-md">
            Loading...
        </div>

        <button onclick="changeMonth(1)"
                class="group p-2 rounded-md hover:bg-accent-dim transition-all border border-transparent hover:border-accent/30">
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="h-6 w-6 text-text-dim group-hover:text-accent transition-colors" viewBox="0 0 20 20"
                 fill="currentColor">
                <path fill-rule="evenodd"
                      d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                      clip-rule="evenodd" />
            </svg>
        </button>
    </div>

    @* --- CALENDAR CONTAINER --- *@
    <div id="calendar-container"
         class="bg-bg-base border border-border-muted rounded-b-lg overflow-hidden shadow-2xl max-w-full mx-auto min-h-[400px]">
        @{
            var months = GetDynamicTermMonths();
            int monthIndex = 0;
        }

        @foreach (var month in months)
        {
            var isCurrent = (BuildTimeProvider.LocalNow >= month && BuildTimeProvider.LocalNow < month.AddMonths(1));
            if (!months.Any(m => BuildTimeProvider.UtcNow >= m && BuildTimeProvider.UtcNow < m.AddMonths(1)) && monthIndex
            == 0)
            {
                isCurrent = true;
            }

            <div class="month-view w-full @(isCurrent ? "" : "hidden")" data-index="@monthIndex"
                 data-label="@month.ToString("MMMM yyyy")">

                @* ========================================= *@
                @* DESKTOP VIEW: GRID LAYOUT (md:grid) *@
                @* ========================================= *@
                <div
                    class="hidden md:grid grid-cols-7 gap-px bg-border-muted text-center text-[11px] uppercase tracking-widest font-bold text-text-dim">
                    <div class="bg-surface-hover py-4 text-accent/70">Sun</div>
                    <div class="bg-surface-hover py-4">Mon</div>
                    <div class="bg-surface-hover py-4">Tue</div>
                    <div class="bg-surface-hover py-4">Wed</div>
                    <div class="bg-surface-hover py-4">Thu</div>
                    <div class="bg-surface-hover py-4">Fri</div>
                    <div class="bg-surface-hover py-4 text-accent/70">Sat</div>
                </div>

                <div class="hidden md:grid grid-cols-7 auto-rows-fr gap-px bg-border-muted">
                    @{
                        var daysInMonth = DateTime.DaysInMonth(month.Year, month.Month);
                        var firstDayOfMonth = new DateTime(month.Year, month.Month, 1);
                        var startOffset = (int)firstDayOfMonth.DayOfWeek;

                        // PREVIOUS MONTH FILLER
                        for (int i = 0; i < startOffset; i++)
                        {
                            <div class="bg-surface/40 min-h-[140px]"></div>
                        }

                        // ACTUAL DAYS
                        for (int day = 1; day <= daysInMonth; day++)
                        {
                            var currentDay = new DateTime(month.Year, month.Month, day);
                            var events = GetEventsForDate(currentDay);
                            var isToday = currentDay.Date == BuildTimeProvider.LocalNow.Date;
                            var isWeekend = currentDay.DayOfWeek == DayOfWeek.Saturday || currentDay.DayOfWeek == DayOfWeek.Sunday;
                            var cellId = $"cell-{month.Year}-{month.Month}-{day}";
                            var visibleEvents = events.Take(3).ToList();
                            var hiddenCount = events.Count - 3;

                            <div class="relative bg-surface min-h-[140px] p-2 transition-all group flex flex-col gap-2
                                hover:bg-surface-hover hover:ring-1 hover:ring-inset hover:ring-accent/50 hover:z-10 cursor-default
                                @(isToday ? "bg-accent/5 ring-1 ring-inset ring-accent/50" : "")">

                                @* Date Indicator *@
                                <div class="flex justify-between items-start">
                                    <span
                                        class="text-sm font-bold w-7 h-7 flex items-center justify-center rounded-full transition-transform group-hover:scale-110
                                        @(isToday ? "bg-accent text-white shadow-lg shadow-accent/20" : (isWeekend ? "text-text-dim" : "text-text-dim group-hover:text-accent"))">
                                        @day
                                    </span>
                                </div>

                                @* Events List *@
                                <div id="@cellId" class="flex flex-col gap-1.5 overflow-hidden max-h-[100px] transition-all duration-300">
                                    @foreach (var evt in visibleEvents)
                                    {
                                        if (!string.IsNullOrEmpty(evt.Url))
                                        {
                                            <a href="@evt.Url" target="_blank"
                                                   class="calendar-event block text-[10px] px-2 py-1 rounded-sm border-l-4 truncate cursor-pointer opacity-90 hover:opacity-100 hover:translate-x-0.5 transition-all shadow-sm @evt.CssClass"
                                                   title="@evt.Tooltip">
                                                <span class="font-medium">@evt.Title</span>
                                            </a>
                                        }
                                        else
                                        {
                                            <div class="calendar-event text-[10px] px-2 py-1 rounded-sm border-l-4 truncate cursor-help opacity-90 hover:opacity-100 transition-all shadow-sm @evt.CssClass"
                                                 title="@evt.Tooltip">
                                                <span class="font-medium">@evt.Title</span>
                                            </div>
                                        }
                                    }
                                    
                                    @* Hidden events (initially hidden) *@
                                    @if (hiddenCount > 0)
                                    {
                                        <div class="hidden-events" style="display: none;">
                                            @foreach (var evt in events.Skip(3))
                                            {
                                                if (!string.IsNullOrEmpty(evt.Url))
                                                {
                                                    <a href="@evt.Url" target="_blank"
                                                           class="calendar-event block text-[10px] px-2 py-1 rounded-sm border-l-4 truncate cursor-pointer opacity-90 hover:opacity-100 hover:translate-x-0.5 transition-all shadow-sm @evt.CssClass"
                                                           title="@evt.Tooltip">
                                                        <span class="font-medium">@evt.Title</span>
                                                    </a>
                                                }
                                                else
                                                {
                                                    <div class="calendar-event text-[10px] px-2 py-1 rounded-sm border-l-4 truncate cursor-help opacity-90 hover:opacity-100 transition-all shadow-sm @evt.CssClass"
                                                         title="@evt.Tooltip">
                                                        <span class="font-medium">@evt.Title</span>
                                                    </div>
                                                }
                                            }
                                        </div>
                                    }
                                </div>
                                
                                @* Show More Link *@
                                @if (hiddenCount > 0)
                                {
                                    <button onclick="toggleCellExpansion('@cellId')"
                                            class="show-more-btn text-[10px] text-accent hover:text-accent-hover font-semibold cursor-pointer transition-colors mt-1 text-left"
                                            data-cell="@cellId">
                                        + @hiddenCount more
                                    </button>
                                }
                            </div>
                        }

                        // NEXT MONTH FILLER
                        var usedCells = startOffset + daysInMonth;
                        var totalCellsNeeded = 42;
                        var remainingCells = totalCellsNeeded - usedCells;

                        for (int i = 0; i < remainingCells; i++)
                        {
                            <div class="bg-surface/40 min-h-[140px]"></div>
                        }
                    }
                </div>

                @* ========================================= *@
                @* MOBILE VIEW: VERTICAL LIST (md:hidden) *@
                @* ========================================= *@
                <div class="md:hidden flex flex-col divide-y divide-border-muted bg-surface">
                    @{
                        // Only show days that actually have events OR are today
                        var mobileDaysInMonth = DateTime.DaysInMonth(month.Year, month.Month);
                        bool hasMobileEvents = false;

                        for (int day = 1; day <= mobileDaysInMonth; day++)
                        {
                            var currentDay = new DateTime(month.Year, month.Month, day);
                            var events = GetEventsForDate(currentDay);
                            var isToday = currentDay.Date == BuildTimeProvider.LocalNow.Date;
                            if (events.Any() || isToday)
                            {
                                hasMobileEvents = true;
                                <div class="flex p-4 gap-4 @(isToday ? "bg-accent/5" : "")">
                                    @* Date Column *@
                                    <div class="flex flex-col items-center min-w-[3.5rem]">
                                        <span class="text-xs uppercase font-bold text-text-dim">@currentDay.ToString("ddd")</span>
                                        <span class="text-2xl font-bold font-mono @(isToday ? "text-accent" : "text-text-main")">
                                            @day
                                        </span>
                                    </div>

                                    @* Events Column *@
                                    <div class="flex-grow flex flex-col gap-2 pt-1">
                                        @if (!events.Any())
                                        {
                                            <span class="text-xs text-text-dim italic">No events scheduled.</span>
                                        }
                                        else
                                        {
                                            @foreach (var evt in events)
                                            {
                                                if (!string.IsNullOrEmpty(evt.Url))
                                                {
                                                    <a href="@evt.Url" target="_blank"
                                                           class="calendar-event block text-xs px-3 py-2 rounded border-l-4 shadow-sm @evt.CssClass hover:brightness-110 active:scale-95 transition-all">
                                                        <span class="font-bold block">@evt.Title</span>
                                                        <span class="text-[10px] opacity-75 block">@evt.Tooltip</span>
                                                    </a>
                                                }
                                                else
                                                {
                                                    <div class="calendar-event text-xs px-3 py-2 rounded border-l-4 shadow-sm @evt.CssClass">
                                                        <span class="font-bold block">@evt.Title</span>
                                                        @* Tooltip for items without URLs (e.g. Holidays) *@
                                                        <span class="text-[10px] opacity-75 block">@evt.Tooltip</span>
                                                    </div>
                                                }
                                            }
                                        }
                                    </div>
                                </div>
                            }
                        }

                        if (!hasMobileEvents)
                        {
                            <div class="p-8 text-center text-text-dim italic">
                                No events scheduled for this month.
                            </div>
                        }
                    }
                </div>

            </div>
            monthIndex++;
        }
    </div>
</div>

@code {
    private List<CalendarEvent> _allEvents = new();

    protected override void OnInitialized()
    {
        LoadEvents();
    }

    // IMPORTANT: Re-initialize JS navigation when the component renders (navigating back to this page)
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JSRuntime.InvokeVoidAsync("initCalendarNav");
    }

    private void LoadEvents()
    {
        _allEvents.Clear();

        // 1. Load Holidays (Using Provider)
        var holidays = HolidaysProvider.GetHolidaysForRange(
        BuildTimeProvider.TermStart,
        BuildTimeProvider.TermEnd
        );

        foreach (var h in holidays)
        {
            _allEvents.Add(new CalendarEvent
            {
                Title = h.Name,
                Tooltip = "Holiday",
                Date = h.Date,
                Type = EventType.Holiday,
                CssClass = "bg-accent/10 text-accent border-accent",
                Url = null
            });
        }

        // 2. Load Custom Calendar Events (Using CalendarEventFrontmatter)
        var customEvents = calendarEventService.Posts;

        foreach (var evt in customEvents)
        {
            var fm = evt.FrontMatter;
            
            // Skip if no dates are defined
            if (fm.Dates == null || !fm.Dates.Any())
                continue;
            
            // Use custom CSS class if provided, otherwise use default based on event type
            string cssClass = fm.CssClass ?? GetDefaultCssForEventType(fm.EventType);

            // Create a calendar event for each date in the Dates list
            foreach (var date in fm.Dates)
            {
                // Only add events within the term range
                if (date >= BuildTimeProvider.TermStart && date <= BuildTimeProvider.TermEnd)
                {
                    _allEvents.Add(new CalendarEvent
                    {
                        Title = fm.Title,
                        Tooltip = string.IsNullOrEmpty(fm.Tooltip) ? fm.EventType.ToString() : fm.Tooltip,
                        Date = date,
                        Type = fm.EventType,
                        CssClass = cssClass,
                        Url = fm.Url
                    });
                }
            }
        }

        // 3. Load Posts (Using Provider)
        var posts = ContentProvider.GetVisiblePosts();

        foreach (var post in posts)
        {
            var fm = post.FrontMatter;
            var postUrl = $"{blazorStaticContentService.Options.PageUrl}/{post.Url}";

            // INJECT TAG CLASSES FOR JS FILTERING
            // e.g. "tag-Homework tag-Labs"
            var tagClasses = string.Join(" ", fm.Tags.Select(t => $"tag-{t.Replace(" ", "-")}"));

            // Note: For event types (Release, Deadline, etc), we keep distinct colors
            // but use adaptive text colors (dark:text-white) to ensure visibility in all themes.
            // A. Release Date
            _allEvents.Add(new CalendarEvent
            {
                Title = fm.Title,
                Tooltip = "Release",
                Date = fm.Published.Date,
                Type = EventType.Release,
                CssClass = $"bg-blue-500/10 text-blue-700 dark:text-blue-300 border-blue-500 {tagClasses}",
                Url = postUrl
            });

            // B. Deadline
            if (fm.Deadline.HasValue)
            {
                _allEvents.Add(new CalendarEvent
                {
                    Title = fm.Title,
                    Tooltip = "Deadline",
                    Date = fm.Deadline.Value.Date,
                    Type = EventType.Deadline,
                    CssClass = $"bg-orange-500/10 text-orange-700 dark:text-orange-300 border-orange-500 font-bold {tagClasses}",
                    Url = postUrl
                });
            }

            // C. Progress
            if (fm.ProgressReportDates != null)
            {
                foreach (var date in fm.ProgressReportDates)
                {
                    _allEvents.Add(new CalendarEvent
                    {
                        Title = fm.Title,
                        Tooltip = "Progress",
                        Date = date.Date,
                        Type = EventType.Progress,
                        CssClass = $"bg-yellow-500/10 text-yellow-700 dark:text-yellow-400 border-yellow-500 {tagClasses}",
                        Url = postUrl
                    });
                }
            }

            // D. Defense
            if (fm.DefenseDates != null)
            {
                foreach (var date in fm.DefenseDates)
                {
                    _allEvents.Add(new CalendarEvent
                    {
                        Title = fm.Title,
                        Tooltip = "Defense",
                        Date = date.Date,
                        Type = EventType.Defense,
                        CssClass = $"bg-green-500/10 text-green-700 dark:text-green-400 border-green-500 {tagClasses}",
                        Url = postUrl
                    });
                }
            }
        }
    }

    private List<DateTime> GetDynamicTermMonths()
    {
        var months = new List<DateTime>();
        var start = BuildTimeProvider.TermStart;
        var end = BuildTimeProvider.TermEnd;

        var current = new DateTime(start.Year, start.Month, 1);
        var lastMonth = new DateTime(end.Year, end.Month, 1);

        while (current <= lastMonth)
        {
            months.Add(current);
            current = current.AddMonths(1);
        }
        return months;
    }

    private List<CalendarEvent> GetEventsForDate(DateTime date)
    {
        return _allEvents
        .Where(e => e.Date.Date == date.Date)
        .OrderBy(e => e.Type)
        .ToList();
    }

    /// <summary>
    /// Returns default CSS classes for a given event type.
    /// Maintains parity with existing event styling.
    /// </summary>
    private string GetDefaultCssForEventType(EventType eventType)
    {
        return eventType switch
        {
            EventType.Holiday => "bg-accent/10 text-accent border-accent",
            EventType.Custom => "bg-accent/10 text-accent border-accent",
            EventType.Release => "bg-blue-500/10 text-blue-700 dark:text-blue-300 border-blue-500",
            EventType.Deadline => "bg-orange-500/10 text-orange-700 dark:text-orange-300 border-orange-500 font-bold",
            EventType.Progress => "bg-yellow-500/10 text-yellow-700 dark:text-yellow-400 border-yellow-500",
            EventType.Defense => "bg-green-500/10 text-green-700 dark:text-green-400 border-green-500",
            _ => "bg-accent/10 text-accent border-accent"
        };
    }
}