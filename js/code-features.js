// wwwroot/code-features.js

/**
 * ENHANCE MARKDOWN CODE BLOCKS
 * * Scans for <pre> blocks generated by the Markdown parser and adds UI enhancements.
 * * Features:
 * 1. Wraps <pre> in a .code-wrapper div for styling.
 * 2. Adds a language label (e.g., "C#", "BASH") based on Prism classes.
 * 3. Injects a "Copy to Clipboard" button with success animation.
 * 4. Triggers Prism.js syntax highlighting on the modified DOM.
 */
window.addCodeFeatures = () => {
    // Map short codes to display names
    const langMap = {
        'cs': 'c#', 'csharp': 'c#', 'cpp': 'c++', 'c': 'c', 'py': 'python', 'python': 'python',
        'js': 'js', 'javascript': 'js', 'ts': 'ts', 'typescript': 'ts', 'html': 'html', 'xml': 'xml',
        'json': 'json', 'yaml': 'yaml', 'md': 'markdown', 'bash': 'bash', 'sh': 'sh',
        'powershell': 'powershell', 'nasm': 'asm', 'asm': 'asm', 'gdscript': 'gdscript'
    };

    // SVG Icons
    const iconCopy = `<rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>`;
    const iconCheck = `<polyline points="20 6 9 17 4 12"/>`;

    // Select code blocks inside the typography container (.prose)
    const preBlocks = document.querySelectorAll('.prose pre');

    preBlocks.forEach(pre => {
        // Prevent double-wrapping if function runs twice
        if (pre.parentElement.classList.contains('code-wrapper')) return;

        // 1. Create Wrapper
        const wrapper = document.createElement('div');
        wrapper.className = 'code-wrapper';
        pre.parentElement.insertBefore(wrapper, pre);
        wrapper.appendChild(pre);

        // 2. Add Language Label
        const className = [...pre.classList].find(c => c.startsWith('language-'));
        if (className) {
            const rawLang = className.replace('language-', '').toLowerCase();
            const label = langMap[rawLang] || rawLang;
            wrapper.setAttribute('data-language', label);
        }

        // 3. Create Copy Button
        const btn = document.createElement('button');
        btn.className = 'copy-button';
        btn.ariaLabel = "Copy code";
        btn.innerHTML = `<svg viewBox="0 0 24 24">${iconCopy}</svg>`;

        btn.addEventListener('click', () => {
            const code = pre.querySelector('code');
            if (!code) return;

            navigator.clipboard.writeText(code.innerText).then(() => {
                // Success State
                btn.classList.add('copied');
                btn.innerHTML = `<svg viewBox="0 0 24 24">${iconCheck}</svg>`;

                // Revert after 2s
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.innerHTML = `<svg viewBox="0 0 24 24">${iconCopy}</svg>`;
                }, 2000);
            }).catch(err => {
                console.error('Copy failed:', err);
            });
        });

        wrapper.appendChild(btn);
    });

    // 4. Trigger Highlighting
    if (window.Prism) {
        window.Prism.highlightAll();
    }
};